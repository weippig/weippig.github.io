---
layout: post
title: Inode
date:  2023-01-13
tags:  Linux 
---

在看 Hands-On System Programming with Go 的時候看到 inode 這個詞，所以看了一下相關的資料並整理成筆記。


### 資料來源
[Linux學習之理解inode](https://www.796t.com/content/1542281710.html)

### inode 是什麼？
檔案儲存在硬碟上，硬碟的最小儲存單位叫做扇區（Sector）。每個扇區儲存512位元組（相當於0.5KB）。


作業系統讀取硬碟的時候，不會一個個扇區地讀取，這樣效率太低，而是一次性連續讀取多個扇區，即一次性讀取一個”塊”（block）。這種由多個扇區組成的”塊”，是檔案存取的最小單位。”塊”的大小，最常見的是4KB，即連續八個 sector組成一個 block。


檔案資料都儲存在”塊”中，那麼很顯然，我們還必須找到一個地方儲存檔案的元資訊，比如檔案的建立者、檔案的建立日期、檔案的大小等等。這種儲存檔案元資訊的區域就叫做inode，中文譯名為”索引節點”。

### inode 的內容？
- 檔案的位元組數
- 檔案擁有者的User ID
- 檔案的Group ID
- 檔案的讀、寫、執行許可權
- 檔案的時間戳，共有三個：ctime指inode上一次變動的時間，mtime指檔案內容上一次變動的時間，atime指檔案上一次開啟的時間。
- 連結數，即有多少檔名指向這個inode
- 檔案資料block的位置
**沒有紀錄檔名！**

用 `stat` 指令得到某檔案的 inode 資訊，在 mac 的話，加上 `-x` flag 獲得人類可讀的標題：
``` shell
stat -x ad,txt

#  File: "ad.txt"
#  Size: 546          FileType: Regular File
#  Mode: (0644/-rw-r--r--)         Uid: (  501/  weilun)  Gid: (   20/   staff)
#Device: 1,7   Inode: 84952848    Links: 1
#Access: Thu Dec 29 16:26:04 2022
#Modify: Fri Dec 23 01:35:13 2022
#Change: Fri Dec 23 01:35:13 2022
# Birth: Thu Dec 15 16:35:29 2022
```
 
### inode 的大小
inode也會消耗硬碟空間，所以硬碟格式化的時候，作業系統自動將硬碟分成兩個區域 : 
1. 資料區，存放檔案資料
2. inode區（inode table），存放inode所包含的資訊。


每個inode節點的大小，一般是128位元組或256位元組。inode節點的總數，在格式化時就給定，一般是每1KB或每2KB就設定一個inode。


用下面指令可以檢視每個硬碟分割槽的inode總數和已經使用的數量
``` shell
df -i
```

**由於每個檔案都必須有一個inode，因此有可能發生inode已經用光，但是硬碟還未存滿的情況。這時，就無法在硬碟上建立新檔案。**

### inode 號碼
每個inode都有一個號碼，作業系統用inode號碼來識別不同的檔案(而不是檔名)。

使用者通過檔名，開啟檔案。實際上經過了三步驟：
1. 系統找到這個檔名對應的inode號碼
2. 通過inode號碼，獲取inode資訊
3. 找到檔案資料所在的block，讀出資料

用 `ls -i `下面指令可以看到某檔案對應的 inode 號碼：
``` shell
ls -i ad.txt 
# 84952848 ad.txt
```

### 目錄檔案
Unix/Linux系統中，目錄（directory）也是一種檔案。開啟目錄，實際上就是開啟目錄檔案。


目錄檔案的結構非常簡單，就是一系列目錄項（dirent）的列表。每個目錄項，由兩部分組成：
1. 所包含檔案的檔名
2. 該檔名對應的inode號碼

如果用 `ls -l 資料夾 ` 查看某資料夾的權限，會發現大家都有執行許可權（x，這是因為目錄檔案內只有檔案檔名和inode號碼，其他資訊都儲存在inode節點中，而讀取inode節點內的資訊會需要目錄檔案的執行許可權（x）。

### 硬連結
一般來說，檔名和 inode 是一對一的關係，但是在 Unix/Linux 系統也允許多個檔名指向同一個 inode 號碼。
這意味著，可以用不同的檔名訪問同樣的內容；而對檔案內容進行修改，會影響到所有檔名；但是，刪除一個檔名，不影響另一個檔名的訪問。這種情況就被稱為”硬連結”（hard link）。


下面用 `ln 原始檔 目標檔案` 命令對 test.txt 建立了硬連結，新建立的檔案叫做 hardlink.txt
``` shell
ln test.txt hardlink.txt     

ls -li    
# total 16
# 86719851 -rw-r--r--  2 weilun  staff  15  1 13 13:52 hardlink.txt
# 86719851 -rw-r--r--  2 weilun  staff  15  1 13 13:52 test.txt
```
可以發現兩者的 inode 號碼相同！用戶名前面的那個 `2` 代表指向該inode的檔名總數，又稱作**連結數**，若是這個數字歸零，系統就會回收這個 inode 號碼。
- 如果對 hardlink.txt  內容作修改，使用 `cat` 指令將 test.txt 內容印出來，會發現內容也改變了！
- 刪除 test.txt，會發現 hardlink.txt 還好好的

> 目錄檔案的”連結數”。建立目錄時，預設會生成兩個目錄項：”.”和”..”。<br/>
前者的inode號碼就是當前目錄的inode號碼，等同於當前目錄的”硬連結”；後者的inode號碼就是當前目錄的父目錄的inode號碼，等同於父目錄的”硬連結”。<br/>
所以，任何一個目錄的”硬連結”總數，總是等於2加上它的子目錄總數（含隱藏目錄）。

### 軟連結
另一種情況，檔案A和檔案B的inode號碼雖然不一樣，但是檔案A的內容是檔案B的路徑。讀取檔案A時，系統會自動將訪問者導向檔案B。


因此，無論開啟哪一個檔案，最終讀取的都是檔案B。這時，檔案A就稱為檔案B的”軟連結”（soft link）或者”符號連結（symbolic link）。


可以用 `ln -s 源文檔案或目錄 目標檔案或目錄` 命令建立軟連結

- 檔案A**依賴**於檔案B存在，如果刪除檔案B，開起檔案A會報錯
- 檔案A指向檔案B的檔名，而不是檔案B的inode號碼，檔案B的inode”連結數”不會因此發生變化。

``` shell
ln -s test.txt softlink.txt   

ls -li 
# total 8
# 86720722 lrwxr-xr-x  1 weilun  staff   8  1 13 14:04 softlink.txt -> test.txt
# 86719851 -rw-r--r--  1 weilun  staff  24  1 13 14:00 test.txt
```

### inode 的特殊用途
1. 有時，檔名包含特殊字元，無法正常刪除。這時，直接刪除inode節點，就能起到刪除檔案的作用。
2. 移動檔案或重新命名檔案，只是改變檔名，不影響inode號碼。
3. 開啟一個檔案以後，系統就以inode號碼來識別這個檔案，不再考慮檔名。因此，通常來說，系統無法從inode號碼得知檔名。


第3點使得軟體更新變得簡單，可以在不關閉軟體的情況下進行更新，不需要重啟。因為系統通過inode號碼，識別執行中的檔案，不通過檔名。


更新的時候，新版檔案以同樣的檔名，生成一個新的inode，不會影響到執行中的檔案。等到下一次執行這個軟體的時候，檔名就自動指向新版檔案，舊版檔案的inode則被回收。


